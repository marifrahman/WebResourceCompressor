if(Object.isUndefined(Effect)){throw ("dragdrop.js requires including script.aculo.us' effects.js library")}var Droppables={drops:[],remove:function(a){this.drops=this.drops.reject(function(b){return b.element==$(a)})},add:function(b){b=$(b);var c=Object.extend({greedy:true,hoverclass:null,tree:false},arguments[1]||{});if(c.containment){c._containers=[];var a=c.containment;if(Object.isArray(a)){a.each(function(d){c._containers.push($(d))})}else{c._containers.push($(a))}}if(c.accept){c.accept=[c.accept].flatten()}Element.makePositioned(b);c.element=b;this.drops.push(c)},findDeepestChild:function(a){deepest=a[0];for(i=1;i<a.length;++i){if(Element.isParent(a[i].element,deepest.element)){deepest=a[i]}}return deepest},isContained:function(c,b){var a;if(b.tree){a=c.treeNode}else{a=c.parentNode}return b._containers.detect(function(d){return a==d})},isAffected:function(c,b,a){return((a.element!=b)&&((!a._containers)||this.isContained(b,a))&&((!a.accept)||(Element.classNames(b).detect(function(d){return a.accept.include(d)})))&&Position.within(a.element,c[0],c[1]))},deactivate:function(a){if(a.hoverclass){Element.removeClassName(a.element,a.hoverclass)}this.last_active=null},activate:function(a){if(a.hoverclass){Element.addClassName(a.element,a.hoverclass)}this.last_active=a},show:function(d,c){if(!this.drops.length){return}var b,a=[];this.drops.each(function(e){if(Droppables.isAffected(d,c,e)){a.push(e)}});if(a.length>0){b=Droppables.findDeepestChild(a)}if(this.last_active&&this.last_active!=b){this.deactivate(this.last_active)}if(b){Position.within(b.element,d[0],d[1]);if(b.onHover){b.onHover(c,b.element,Position.overlap(b.overlap,b.element))}if(b!=this.last_active){Droppables.activate(b)}}},fire:function(b,a){if(!this.last_active){return}Position.prepare();if(this.isAffected([Event.pointerX(b),Event.pointerY(b)],a,this.last_active)){if(this.last_active.onDrop){this.last_active.onDrop(a,this.last_active.element,b);return true}}},reset:function(){if(this.last_active){this.deactivate(this.last_active)}}};var Draggables={drags:[],observers:[],register:function(a){if(this.drags.length==0){this.eventMouseUp=this.endDrag.bindAsEventListener(this);this.eventMouseMove=this.updateDrag.bindAsEventListener(this);this.eventKeypress=this.keyPress.bindAsEventListener(this);Event.observe(document,"mouseup",this.eventMouseUp);Event.observe(document,"mousemove",this.eventMouseMove);Event.observe(document,"keypress",this.eventKeypress)}this.drags.push(a)},unregister:function(a){this.drags=this.drags.reject(function(b){return b==a});if(this.drags.length==0){Event.stopObserving(document,"mouseup",this.eventMouseUp);Event.stopObserving(document,"mousemove",this.eventMouseMove);Event.stopObserving(document,"keypress",this.eventKeypress)}},activate:function(a){if(a.options.delay){this._timeout=setTimeout(function(){Draggables._timeout=null;window.focus();Draggables.activeDraggable=a}.bind(this),a.options.delay)}else{window.focus();this.activeDraggable=a}},deactivate:function(){this.activeDraggable=null},updateDrag:function(a){if(!this.activeDraggable){return}var b=[Event.pointerX(a),Event.pointerY(a)];if(this._lastPointer&&(this._lastPointer.inspect()==b.inspect())){return}this._lastPointer=b;this.activeDraggable.updateDrag(a,b)},endDrag:function(a){if(this._timeout){clearTimeout(this._timeout);this._timeout=null}if(!this.activeDraggable){return}this._lastPointer=null;this.activeDraggable.endDrag(a);this.activeDraggable=null},keyPress:function(a){if(this.activeDraggable){this.activeDraggable.keyPress(a)}},addObserver:function(a){this.observers.push(a);this._cacheObserverCallbacks()},removeObserver:function(a){this.observers=this.observers.reject(function(b){return b.element==a});this._cacheObserverCallbacks()},notify:function(c,a,b){if(this[c+"Count"]>0){this.observers.each(function(d){if(d[c]){d[c](c,a,b)}})}if(a.options[c]){a.options[c](a,b)}},_cacheObserverCallbacks:function(){["onStart","onEnd","onDrag"].each(function(a){Draggables[a+"Count"]=Draggables.observers.select(function(b){return b[a]}).length})}};var Draggable=Class.create({initialize:function(b){var a={handle:false,reverteffect:function(e,g,f){var d=Math.sqrt(Math.abs(g^2)+Math.abs(f^2))*0.02;new Effect.Move(e,{x:-f,y:-g,duration:d,queue:{scope:"_draggable",position:"end"}})},endeffect:function(d){var e=Object.isNumber(d._opacity)?d._opacity:1;new Effect.Opacity(d,{duration:0.2,from:0.7,to:e,queue:{scope:"_draggable",position:"end"},afterFinish:function(){Draggable._dragging[d]=false}})},zindex:1000,revert:false,quiet:false,scroll:false,scrollSensitivity:20,scrollSpeed:15,snap:false,delay:0};if(!arguments[1]||Object.isUndefined(arguments[1].endeffect)){Object.extend(a,{starteffect:function(d){d._opacity=Element.getOpacity(d);Draggable._dragging[d]=true;new Effect.Opacity(d,{duration:0.2,from:d._opacity,to:0.7})}})}var c=Object.extend(a,arguments[1]||{});this.element=$(b);if(c.handle&&Object.isString(c.handle)){this.handle=this.element.down("."+c.handle,0)}if(!this.handle){this.handle=$(c.handle)}if(!this.handle){this.handle=this.element}if(c.scroll&&!c.scroll.scrollTo&&!c.scroll.outerHTML){c.scroll=$(c.scroll);this._isScrollChild=Element.childOf(this.element,c.scroll)}Element.makePositioned(this.element);this.options=c;this.dragging=false;this.eventMouseDown=this.initDrag.bindAsEventListener(this);Event.observe(this.handle,"mousedown",this.eventMouseDown);Draggables.register(this)},destroy:function(){Event.stopObserving(this.handle,"mousedown",this.eventMouseDown);Draggables.unregister(this)},currentDelta:function(){return([parseInt(Element.getStyle(this.element,"left")||"0"),parseInt(Element.getStyle(this.element,"top")||"0")])},initDrag:function(a){if(!Object.isUndefined(Draggable._dragging[this.element])&&Draggable._dragging[this.element]){return}if(Event.isLeftClick(a)){var d=Event.element(a);if((tag_name=d.tagName.toUpperCase())&&(tag_name=="INPUT"||tag_name=="SELECT"||tag_name=="OPTION"||tag_name=="BUTTON"||tag_name=="TEXTAREA")){return}var b=[Event.pointerX(a),Event.pointerY(a)];var c=Position.cumulativeOffset(this.element);this.offset=[0,1].map(function(e){return(b[e]-c[e])});Draggables.activate(this);Event.stop(a)}},startDrag:function(a){this.dragging=true;if(!this.delta){this.delta=this.currentDelta()}if(this.options.zindex){this.originalZ=parseInt(Element.getStyle(this.element,"z-index")||0);this.element.style.zIndex=this.options.zindex}if(this.options.ghosting){this._clone=this.element.cloneNode(true);this._originallyAbsolute=(this.element.getStyle("position")=="absolute");if(!this._originallyAbsolute){Position.absolutize(this.element)}this.element.parentNode.insertBefore(this._clone,this.element)}if(this.options.scroll){if(this.options.scroll==window){var b=this._getWindowScroll(this.options.scroll);this.originalScrollLeft=b.left;this.originalScrollTop=b.top}else{this.originalScrollLeft=this.options.scroll.scrollLeft;this.originalScrollTop=this.options.scroll.scrollTop}}Draggables.notify("onStart",this,a);if(this.options.starteffect){this.options.starteffect(this.element)}},updateDrag:function(event,pointer){if(!this.dragging){this.startDrag(event)}if(!this.options.quiet){Position.prepare();Droppables.show(pointer,this.element)}Draggables.notify("onDrag",this,event);this.draw(pointer);if(this.options.change){this.options.change(this)}if(this.options.scroll){this.stopScrolling();var p;if(this.options.scroll==window){with(this._getWindowScroll(this.options.scroll)){p=[left,top,left+width,top+height]}}else{p=Position.page(this.options.scroll);p[0]+=this.options.scroll.scrollLeft+Position.deltaX;p[1]+=this.options.scroll.scrollTop+Position.deltaY;p.push(p[0]+this.options.scroll.offsetWidth);p.push(p[1]+this.options.scroll.offsetHeight)}var speed=[0,0];if(pointer[0]<(p[0]+this.options.scrollSensitivity)){speed[0]=pointer[0]-(p[0]+this.options.scrollSensitivity)}if(pointer[1]<(p[1]+this.options.scrollSensitivity)){speed[1]=pointer[1]-(p[1]+this.options.scrollSensitivity)}if(pointer[0]>(p[2]-this.options.scrollSensitivity)){speed[0]=pointer[0]-(p[2]-this.options.scrollSensitivity)}if(pointer[1]>(p[3]-this.options.scrollSensitivity)){speed[1]=pointer[1]-(p[3]-this.options.scrollSensitivity)}this.startScrolling(speed)}if(Prototype.Browser.WebKit){window.scrollBy(0,0)}Event.stop(event)},finishDrag:function(c,g){this.dragging=false;if(this.options.quiet){Position.prepare();var e=[Event.pointerX(c),Event.pointerY(c)];Droppables.show(e,this.element)}if(this.options.ghosting){if(!this._originallyAbsolute){Position.relativize(this.element)}delete this._originallyAbsolute;Element.remove(this._clone);this._clone=null}var b=false;if(g){b=Droppables.fire(c,this.element);if(!b){b=false}}if(b&&this.options.onDropped){this.options.onDropped(this.element)}Draggables.notify("onEnd",this,c);var f=this.options.revert;if(f&&Object.isFunction(f)){f=f(this.element)}var a=this.currentDelta();if(f&&this.options.reverteffect){if(b==0||f!="failure"){this.options.reverteffect(this.element,a[1]-this.delta[1],a[0]-this.delta[0])}}else{this.delta=a}if(this.options.zindex){this.element.style.zIndex=this.originalZ}if(this.options.endeffect){this.options.endeffect(this.element)}Draggables.deactivate(this);Droppables.reset()},keyPress:function(a){if(a.keyCode!=Event.KEY_ESC){return}this.finishDrag(a,false);Event.stop(a)},endDrag:function(a){if(!this.dragging){return}this.stopScrolling();this.finishDrag(a,true);Event.stop(a)},draw:function(c){var e=Position.cumulativeOffset(this.element);if(this.options.ghosting){var f=Position.realOffset(this.element);e[0]+=f[0]-Position.deltaX;e[1]+=f[1]-Position.deltaY}var a=this.currentDelta();e[0]-=a[0];e[1]-=a[1];if(this.options.scroll&&(this.options.scroll!=window&&this._isScrollChild)){e[0]-=this.options.scroll.scrollLeft-this.originalScrollLeft;e[1]-=this.options.scroll.scrollTop-this.originalScrollTop}var b=[0,1].map(function(d){return(c[d]-e[d]-this.offset[d])}.bind(this));if(this.options.snap){if(Object.isFunction(this.options.snap)){b=this.options.snap(b[0],b[1],this)}else{if(Object.isArray(this.options.snap)){b=b.map(function(h,d){return(h/this.options.snap[d]).round()*this.options.snap[d]}.bind(this))}else{b=b.map(function(d){return(d/this.options.snap).round()*this.options.snap}.bind(this))}}}var g=this.element.style;if((!this.options.constraint)||(this.options.constraint=="horizontal")){g.left=b[0]+"px"}if((!this.options.constraint)||(this.options.constraint=="vertical")){g.top=b[1]+"px"}if(g.visibility=="hidden"){g.visibility=""}},stopScrolling:function(){if(this.scrollInterval){clearInterval(this.scrollInterval);this.scrollInterval=null;Draggables._lastScrollPointer=null}},startScrolling:function(a){if(!(a[0]||a[1])){return}this.scrollSpeed=[a[0]*this.options.scrollSpeed,a[1]*this.options.scrollSpeed];this.lastScrolled=new Date();this.scrollInterval=setInterval(this.scroll.bind(this),10)},scroll:function(){var current=new Date();var delta=current-this.lastScrolled;this.lastScrolled=current;if(this.options.scroll==window){with(this._getWindowScroll(this.options.scroll)){if(this.scrollSpeed[0]||this.scrollSpeed[1]){var d=delta/1000;this.options.scroll.scrollTo(left+d*this.scrollSpeed[0],top+d*this.scrollSpeed[1])}}}else{this.options.scroll.scrollLeft+=this.scrollSpeed[0]*delta/1000;this.options.scroll.scrollTop+=this.scrollSpeed[1]*delta/1000}Position.prepare();Droppables.show(Draggables._lastPointer,this.element);Draggables.notify("onDrag",this);if(this._isScrollChild){Draggables._lastScrollPointer=Draggables._lastScrollPointer||$A(Draggables._lastPointer);Draggables._lastScrollPointer[0]+=this.scrollSpeed[0]*delta/1000;Draggables._lastScrollPointer[1]+=this.scrollSpeed[1]*delta/1000;if(Draggables._lastScrollPointer[0]<0){Draggables._lastScrollPointer[0]=0}if(Draggables._lastScrollPointer[1]<0){Draggables._lastScrollPointer[1]=0}this.draw(Draggables._lastScrollPointer)}if(this.options.change){this.options.change(this)}},_getWindowScroll:function(w){var T,L,W,H;with(w.document){if(w.document.documentElement&&documentElement.scrollTop){T=documentElement.scrollTop;L=documentElement.scrollLeft}else{if(w.document.body){T=body.scrollTop;L=body.scrollLeft}}if(w.innerWidth){W=w.innerWidth;H=w.innerHeight}else{if(w.document.documentElement&&documentElement.clientWidth){W=documentElement.clientWidth;H=documentElement.clientHeight}else{W=body.offsetWidth;H=body.offsetHeight}}}return{top:T,left:L,width:W,height:H}}});Draggable._dragging={};var SortableObserver=Class.create({initialize:function(a,b){this.element=$(a);this.observer=b;this.lastValue=Sortable.serialize(this.element)},onStart:function(){this.lastValue=Sortable.serialize(this.element)},onEnd:function(){Sortable.unmark();if(this.lastValue!=Sortable.serialize(this.element)){this.observer(this.element)}}});var Sortable={SERIALIZE_RULE:/^[^_\-](?:[A-Za-z0-9\-\_]*)[_](.*)$/,sortables:{},_findRootElement:function(a){while(a.tagName.toUpperCase()!="BODY"){if(a.id&&Sortable.sortables[a.id]){return a}a=a.parentNode}},options:function(a){a=Sortable._findRootElement($(a));if(!a){return}return Sortable.sortables[a.id]},destroy:function(a){a=$(a);var b=Sortable.sortables[a.id];if(b){Draggables.removeObserver(b.element);b.droppables.each(function(c){Droppables.remove(c)});b.draggables.invoke("destroy");delete Sortable.sortables[b.element.id]}},create:function(a){a=$(a);var b=Object.extend({element:a,tag:"li",dropOnEmpty:false,tree:false,treeTag:"ul",overlap:"vertical",constraint:"vertical",containment:a,handle:false,only:false,delay:0,hoverclass:null,ghosting:false,quiet:false,scroll:false,scrollSensitivity:20,scrollSpeed:15,format:this.SERIALIZE_RULE,elements:false,handles:false,onChange:Prototype.emptyFunction,onUpdate:Prototype.emptyFunction},arguments[1]||{});this.destroy(a);var c={revert:true,quiet:b.quiet,scroll:b.scroll,scrollSpeed:b.scrollSpeed,scrollSensitivity:b.scrollSensitivity,delay:b.delay,ghosting:b.ghosting,constraint:b.constraint,handle:b.handle};if(b.starteffect){c.starteffect=b.starteffect}if(b.reverteffect){c.reverteffect=b.reverteffect}else{if(b.ghosting){c.reverteffect=function(f){f.style.top=0;f.style.left=0}}}if(b.endeffect){c.endeffect=b.endeffect}if(b.zindex){c.zindex=b.zindex}var d={overlap:b.overlap,containment:b.containment,tree:b.tree,hoverclass:b.hoverclass,onHover:Sortable.onHover};var e={onHover:Sortable.onEmptyHover,overlap:b.overlap,containment:b.containment,hoverclass:b.hoverclass};Element.cleanWhitespace(a);b.draggables=[];b.droppables=[];if(b.dropOnEmpty||b.tree){Droppables.add(a,e);b.droppables.push(a)}(b.elements||this.findElements(a,b)||[]).each(function(f,h){var g=b.handles?$(b.handles[h]):(b.handle?$(f).select("."+b.handle)[0]:f);b.draggables.push(new Draggable(f,Object.extend(c,{handle:g})));Droppables.add(f,d);if(b.tree){f.treeNode=a}b.droppables.push(f)});if(b.tree){(Sortable.findTreeElements(a,b)||[]).each(function(f){Droppables.add(f,e);f.treeNode=a;b.droppables.push(f)})}this.sortables[a.id]=b;Draggables.addObserver(new SortableObserver(a,b.onUpdate))},findElements:function(a,b){return Element.findChildren(a,b.only,b.tree?true:false,b.tag)},findTreeElements:function(a,b){return Element.findChildren(a,b.only,b.tree?true:false,b.treeTag)},onHover:function(b,a,e){if(Element.isParent(a,b)){return}if(e>0.33&&e<0.66&&Sortable.options(a).tree){return}else{if(e>0.5){Sortable.mark(a,"before");if(a.previousSibling!=b){var d=b.parentNode;b.style.visibility="hidden";a.parentNode.insertBefore(b,a);if(a.parentNode!=d){Sortable.options(d).onChange(b)}Sortable.options(a.parentNode).onChange(b)}}else{Sortable.mark(a,"after");var c=a.nextSibling||null;if(c!=b){var d=b.parentNode;b.style.visibility="hidden";a.parentNode.insertBefore(b,c);if(a.parentNode!=d){Sortable.options(d).onChange(b)}Sortable.options(a.parentNode).onChange(b)}}}},onEmptyHover:function(e,c,j){var h=e.parentNode;var d=Sortable.options(c);if(!Element.isParent(c,e)){var f;var b=Sortable.findElements(c,{tag:d.tag,only:d.only});var a=null;if(b){var g=Element.offsetSize(c,d.overlap)*(1-j);for(f=0;f<b.length;f+=1){if(g-Element.offsetSize(b[f],d.overlap)>=0){g-=Element.offsetSize(b[f],d.overlap)}else{if(g-(Element.offsetSize(b[f],d.overlap)/2)>=0){a=f+1<b.length?b[f+1]:null;break}else{a=b[f];break}}}}c.insertBefore(e,a);Sortable.options(h).onChange(e);d.onChange(e)}},unmark:function(){if(Sortable._marker){Sortable._marker.hide()}},mark:function(a,c){var d=Sortable.options(a.parentNode);if(d&&!d.ghosting){return}if(!Sortable._marker){Sortable._marker=($("dropmarker")||Element.extend(document.createElement("DIV"))).hide().addClassName("dropmarker").setStyle({position:"absolute"});document.getElementsByTagName("body").item(0).appendChild(Sortable._marker)}var b=Position.cumulativeOffset(a);Sortable._marker.setStyle({left:b[0]+"px",top:b[1]+"px"});if(c=="after"){if(d.overlap=="horizontal"){Sortable._marker.setStyle({left:(b[0]+a.clientWidth)+"px"})}else{Sortable._marker.setStyle({top:(b[1]+a.clientHeight)+"px"})}}Sortable._marker.show()},_tree:function(c,f,g){var b=Sortable.findElements(c,f)||[];for(var d=0;d<b.length;++d){var e=b[d].id.match(f.format);if(!e){continue}var a={id:encodeURIComponent(e?e[1]:null),element:c,parent:g,children:[],position:g.children.length,container:$(b[d]).down(f.treeTag)};if(a.container){this._tree(a.container,f,a)}g.children.push(a)}return g},tree:function(a){a=$(a);var d=this.options(a);var b=Object.extend({tag:d.tag,treeTag:d.treeTag,only:d.only,name:a.id,format:d.format},arguments[1]||{});var c={id:null,parent:null,children:[],container:a,position:0};return Sortable._tree(a,b,c)},_constructIndex:function(b){var a="";do{if(b.id){a="["+b.position+"]"+a}}while((b=b.parent)!=null);return a},sequence:function(a){a=$(a);var b=Object.extend(this.options(a),arguments[1]||{});return $(this.findElements(a,b)||[]).map(function(c){return c.id.match(b.format)?c.id.match(b.format)[1]:""})},setSequence:function(a,b){a=$(a);var d=Object.extend(this.options(a),arguments[2]||{});var c={};this.findElements(a,d).each(function(e){if(e.id.match(d.format)){c[e.id.match(d.format)[1]]=[e,e.parentNode]}e.parentNode.removeChild(e)});b.each(function(e){var f=c[e];if(f){f[1].appendChild(f[0]);delete c[e]}})},serialize:function(a){a=$(a);var c=Object.extend(Sortable.options(a),arguments[1]||{});var b=encodeURIComponent((arguments[1]&&arguments[1].name)?arguments[1].name:a.id);if(c.tree){return Sortable.tree(a,arguments[1]).children.map(function(d){return[b+Sortable._constructIndex(d)+"[id]="+encodeURIComponent(d.id)].concat(d.children.map(arguments.callee))}).flatten().join("&")}else{return Sortable.sequence(a,arguments[1]).map(function(d){return b+"[]="+encodeURIComponent(d)}).join("&")}}};Element.isParent=function(a,b){if(!a.parentNode||a==b){return false}if(a.parentNode==b){return true}return Element.isParent(a.parentNode,b)};Element.findChildren=function(a,c,d,e){if(!a.hasChildNodes()){return null}e=e.toUpperCase();if(c){c=[c].flatten()}var b=[];$A(a.childNodes).each(function(f){if(f.tagName&&f.tagName.toUpperCase()==e&&(!c||(Element.classNames(f).detect(function(h){return c.include(h)})))){b.push(f)}if(d){var g=Element.findChildren(f,c,d,e);if(g){b.push(g)}}});return(b.length>0?b.flatten():[])};Element.offsetSize=function(a,b){return a["offset"+((b=="vertical"||b=="height")?"Height":"Width")]};