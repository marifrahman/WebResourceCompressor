Event.simulateMouse=function(a,b){var d=Object.extend({pointerX:0,pointerY:0,buttons:0,ctrlKey:false,altKey:false,shiftKey:false,metaKey:false},arguments[2]||{});var c=document.createEvent("MouseEvents");c.initMouseEvent(b,true,true,document.defaultView,d.buttons,d.pointerX,d.pointerY,d.pointerX,d.pointerY,d.ctrlKey,d.altKey,d.shiftKey,d.metaKey,0,$(a));if(this.mark){Element.remove(this.mark)}this.mark=document.createElement("div");this.mark.appendChild(document.createTextNode(" "));document.body.appendChild(this.mark);this.mark.style.position="absolute";this.mark.style.top=d.pointerY+"px";this.mark.style.left=d.pointerX+"px";this.mark.style.width="5px";this.mark.style.height="5px;";this.mark.style.borderTop="1px solid red;";this.mark.style.borderLeft="1px solid red;";if(this.step){alert("["+new Date().getTime().toString()+"] "+b+"/"+Test.Unit.inspect(d))}$(a).dispatchEvent(c)};Event.simulateKey=function(a,b){var d=Object.extend({ctrlKey:false,altKey:false,shiftKey:false,metaKey:false,keyCode:0,charCode:0},arguments[2]||{});var c=document.createEvent("KeyEvents");c.initKeyEvent(b,true,true,window,d.ctrlKey,d.altKey,d.shiftKey,d.metaKey,d.keyCode,d.charCode);$(a).dispatchEvent(c)};Event.simulateKeys=function(b,a){for(var c=0;c<a.length;c++){Event.simulateKey(b,"keypress",{charCode:a.charCodeAt(c)})}};var Test={};Test.Unit={};Test.Unit.inspect=Object.inspect;Test.Unit.Logger=Class.create();Test.Unit.Logger.prototype={initialize:function(a){this.log=$(a);if(this.log){this._createLogTable()}},start:function(a){if(!this.log){return}this.testName=a;this.lastLogLine=document.createElement("tr");this.statusCell=document.createElement("td");this.nameCell=document.createElement("td");this.nameCell.className="nameCell";this.nameCell.appendChild(document.createTextNode(a));this.messageCell=document.createElement("td");this.lastLogLine.appendChild(this.statusCell);this.lastLogLine.appendChild(this.nameCell);this.lastLogLine.appendChild(this.messageCell);this.loglines.appendChild(this.lastLogLine)},finish:function(a,b){if(!this.log){return}this.lastLogLine.className=a;this.statusCell.innerHTML=a;this.messageCell.innerHTML=this._toHTML(b);this.addLinksToResults()},message:function(a){if(!this.log){return}this.messageCell.innerHTML=this._toHTML(a)},summary:function(a){if(!this.log){return}this.logsummary.innerHTML=this._toHTML(a)},_createLogTable:function(){this.log.innerHTML='<div id="logsummary"></div><table id="logtable"><thead><tr><th>Status</th><th>Test</th><th>Message</th></tr></thead><tbody id="loglines"></tbody></table>';this.logsummary=$("logsummary");this.loglines=$("loglines")},_toHTML:function(a){return a.escapeHTML().replace(/\n/g,"<br/>")},addLinksToResults:function(){$$("tr.failed .nameCell").each(function(a){a.title="Run only this test";Event.observe(a,"click",function(){window.location.search="?tests="+a.innerHTML})});$$("tr.passed .nameCell").each(function(a){a.title="Run all tests";Event.observe(a,"click",function(){window.location.search=""})})}};Test.Unit.Runner=Class.create();Test.Unit.Runner.prototype={initialize:function(c){this.options=Object.extend({testLog:"testlog"},arguments[1]||{});this.options.resultsURL=this.parseResultsURLQueryParameter();this.options.tests=this.parseTestsQueryParameter();if(this.options.testLog){this.options.testLog=$(this.options.testLog)||null}if(this.options.tests){this.tests=[];for(var a=0;a<this.options.tests.length;a++){if(/^test/.test(this.options.tests[a])){this.tests.push(new Test.Unit.Testcase(this.options.tests[a],c[this.options.tests[a]],c.setup,c.teardown))}}}else{if(this.options.test){this.tests=[new Test.Unit.Testcase(this.options.test,c[this.options.test],c.setup,c.teardown)]}else{this.tests=[];for(var b in c){if(/^test/.test(b)){this.tests.push(new Test.Unit.Testcase(this.options.context?" -> "+this.options.titles[b]:b,c[b],c.setup,c.teardown))}}}}this.currentTest=0;this.logger=new Test.Unit.Logger(this.options.testLog);setTimeout(this.runTests.bind(this),1000)},parseResultsURLQueryParameter:function(){return window.location.search.parseQuery()["resultsURL"]},parseTestsQueryParameter:function(){if(window.location.search.parseQuery()["tests"]){return window.location.search.parseQuery()["tests"].split(",")}},getResult:function(){var a=false;for(var b=0;b<this.tests.length;b++){if(this.tests[b].errors>0){return"ERROR"}if(this.tests[b].failures>0){a=true}}if(a){return"FAILURE"}else{return"SUCCESS"}},postResults:function(){if(this.options.resultsURL){new Ajax.Request(this.options.resultsURL,{method:"get",parameters:"result="+this.getResult(),asynchronous:false})}},runTests:function(){var a=this.tests[this.currentTest];if(!a){this.postResults();this.logger.summary(this.summary());return}if(!a.isWaiting){this.logger.start(a.name)}a.run();if(a.isWaiting){this.logger.message("Waiting for "+a.timeToWait+"ms");setTimeout(this.runTests.bind(this),a.timeToWait||1000)}else{this.logger.finish(a.status(),a.summary());this.currentTest++;this.runTests()}},summary:function(){var a=0;var c=0;var b=0;var e=[];for(var d=0;d<this.tests.length;d++){a+=this.tests[d].assertions;c+=this.tests[d].failures;b+=this.tests[d].errors}return((this.options.context?this.options.context+": ":"")+this.tests.length+" tests, "+a+" assertions, "+c+" failures, "+b+" errors")}};Test.Unit.Assertions=Class.create();Test.Unit.Assertions.prototype={initialize:function(){this.assertions=0;this.failures=0;this.errors=0;this.messages=[]},summary:function(){return(this.assertions+" assertions, "+this.failures+" failures, "+this.errors+" errors\n"+this.messages.join("\n"))},pass:function(){this.assertions++},fail:function(a){this.failures++;this.messages.push("Failure: "+a)},info:function(a){this.messages.push("Info: "+a)},error:function(a){this.errors++;this.messages.push(a.name+": "+a.message+"("+Test.Unit.inspect(a)+")")},status:function(){if(this.failures>0){return"failed"}if(this.errors>0){return"error"}return"passed"},assert:function(b){var c=arguments[1]||'assert: got "'+Test.Unit.inspect(b)+'"';try{b?this.pass():this.fail(c)}catch(a){this.error(a)}},assertEqual:function(c,a){var d=arguments[2]||"assertEqual";try{(c==a)?this.pass():this.fail(d+': expected "'+Test.Unit.inspect(c)+'", actual "'+Test.Unit.inspect(a)+'"')}catch(b){this.error(b)}},assertInspect:function(c,a){var d=arguments[2]||"assertInspect";try{(c==a.inspect())?this.pass():this.fail(d+': expected "'+Test.Unit.inspect(c)+'", actual "'+Test.Unit.inspect(a)+'"')}catch(b){this.error(b)}},assertEnumEqual:function(c,a){var d=arguments[2]||"assertEnumEqual";try{$A(c).length==$A(a).length&&c.zip(a).all(function(e){return e[0]==e[1]})?this.pass():this.fail(d+": expected "+Test.Unit.inspect(c)+", actual "+Test.Unit.inspect(a))}catch(b){this.error(b)}},assertNotEqual:function(c,a){var d=arguments[2]||"assertNotEqual";try{(c!=a)?this.pass():this.fail(d+': got "'+Test.Unit.inspect(a)+'"')}catch(b){this.error(b)}},assertIdentical:function(c,a){var d=arguments[2]||"assertIdentical";try{(c===a)?this.pass():this.fail(d+': expected "'+Test.Unit.inspect(c)+'", actual "'+Test.Unit.inspect(a)+'"')}catch(b){this.error(b)}},assertNotIdentical:function(c,a){var d=arguments[2]||"assertNotIdentical";try{!(c===a)?this.pass():this.fail(d+': expected "'+Test.Unit.inspect(c)+'", actual "'+Test.Unit.inspect(a)+'"')}catch(b){this.error(b)}},assertNull:function(c){var b=arguments[1]||"assertNull";try{(c==null)?this.pass():this.fail(b+': got "'+Test.Unit.inspect(c)+'"')}catch(a){this.error(a)}},assertMatch:function(c,a){var d=arguments[2]||"assertMatch";var f=new RegExp(c);try{(f.exec(a))?this.pass():this.fail(d+' : regex: "'+Test.Unit.inspect(c)+" did not match: "+Test.Unit.inspect(a)+'"')}catch(b){this.error(b)}},assertHidden:function(a){var b=arguments[1]||"assertHidden";this.assertEqual("none",a.style.display,b)},assertNotNull:function(b){var a=arguments[1]||"assertNotNull";this.assert(b!=null,a)},assertType:function(c,a){var d=arguments[2]||"assertType";try{(a.constructor==c)?this.pass():this.fail(d+': expected "'+Test.Unit.inspect(c)+'", actual "'+(a.constructor)+'"')}catch(b){this.error(b)}},assertNotOfType:function(c,a){var d=arguments[2]||"assertNotOfType";try{(a.constructor!=c)?this.pass():this.fail(d+': expected "'+Test.Unit.inspect(c)+'", actual "'+(a.constructor)+'"')}catch(b){this.error(b)}},assertInstanceOf:function(c,a){var d=arguments[2]||"assertInstanceOf";try{(a instanceof c)?this.pass():this.fail(d+": object was not an instance of the expected type")}catch(b){this.error(b)}},assertNotInstanceOf:function(c,a){var d=arguments[2]||"assertNotInstanceOf";try{!(a instanceof c)?this.pass():this.fail(d+": object was an instance of the not expected type")}catch(b){this.error(b)}},assertRespondsTo:function(c,d){var b=arguments[2]||"assertRespondsTo";try{(d[c]&&typeof d[c]=="function")?this.pass():this.fail(b+": object doesn't respond to ["+c+"]")}catch(a){this.error(a)}},assertReturnsTrue:function(d,f){var c=arguments[2]||"assertReturnsTrue";try{var b=f[d];if(!b){b=f["is"+d.charAt(0).toUpperCase()+d.slice(1)]}b()?this.pass():this.fail(c+": method returned false")}catch(a){this.error(a)}},assertReturnsFalse:function(d,f){var c=arguments[2]||"assertReturnsFalse";try{var b=f[d];if(!b){b=f["is"+d.charAt(0).toUpperCase()+d.slice(1)]}!b()?this.pass():this.fail(c+": method returned true")}catch(a){this.error(a)}},assertRaise:function(b,d){var c=arguments[2]||"assertRaise";try{d();this.fail(c+": exception expected but none was raised")}catch(a){((b==null)||(a.name==b))?this.pass():this.error(a)}},assertElementsMatch:function(){var b=$A(arguments),a=$A(b.shift());if(a.length!=b.length){this.fail("assertElementsMatch: size mismatch: "+a.length+" elements, "+b.length+" expressions");return false}a.zip(b).all(function(f,e){var c=$(f.first()),d=f.last();if(c.match(d)){return true}this.fail("assertElementsMatch: (in index "+e+") expected "+d.inspect()+" but got "+c.inspect())}.bind(this))&&this.pass()},assertElementMatches:function(a,b){this.assertElementsMatch([a],b)},benchmark:function(b,a){var c=new Date();(a||1).times(b);var d=((new Date())-c);this.info((arguments[2]||"Operation")+" finished "+a+" iterations in "+(d/1000)+"s");return d},_isVisible:function(a){a=$(a);if(!a.parentNode){return true}this.assertNotNull(a);if(a.style&&Element.getStyle(a,"display")=="none"){return false}return this._isVisible(a.parentNode)},assertNotVisible:function(a){this.assert(!this._isVisible(a),Test.Unit.inspect(a)+" was not hidden and didn't have a hidden parent either. "+(""||arguments[1]))},assertVisible:function(a){this.assert(this._isVisible(a),Test.Unit.inspect(a)+" was not visible. "+(""||arguments[1]))},benchmark:function(b,a){var c=new Date();(a||1).times(b);var d=((new Date())-c);this.info((arguments[2]||"Operation")+" finished "+a+" iterations in "+(d/1000)+"s");return d}};Test.Unit.Testcase=Class.create();Object.extend(Object.extend(Test.Unit.Testcase.prototype,Test.Unit.Assertions.prototype),{initialize:function(name,test,setup,teardown){Test.Unit.Assertions.prototype.initialize.bind(this)();this.name=name;if(typeof test=="string"){test=test.gsub(/(\.should[^\(]+\()/,"#{0}this,");test=test.gsub(/(\.should[^\(]+)\(this,\)/,"#{1}(this)");this.test=function(){eval("with(this){"+test+"}")}}else{this.test=test||function(){}}this.setup=setup||function(){};this.teardown=teardown||function(){};this.isWaiting=false;this.timeToWait=1000},wait:function(b,a){this.isWaiting=true;this.test=a;this.timeToWait=b},run:function(){try{try{if(!this.isWaiting){this.setup.bind(this)()}this.isWaiting=false;this.test.bind(this)()}finally{if(!this.isWaiting){this.teardown.bind(this)()}}}catch(a){this.error(a)}}});Test.setupBDDExtensionMethods=function(){var b={shouldEqual:"assertEqual",shouldNotEqual:"assertNotEqual",shouldEqualEnum:"assertEnumEqual",shouldBeA:"assertType",shouldNotBeA:"assertNotOfType",shouldBeAn:"assertType",shouldNotBeAn:"assertNotOfType",shouldBeNull:"assertNull",shouldNotBeNull:"assertNotNull",shouldBe:"assertReturnsTrue",shouldNotBe:"assertReturnsFalse",shouldRespondTo:"assertRespondsTo"};var a=function(d,c,e){this[d].apply(this,(c||[]).concat([e]))};Test.BDDMethods={};$H(b).each(function(c){Test.BDDMethods[c.key]=function(){var d=$A(arguments);var e=d.shift();a.apply(e,[c.value,d,this])}});[Array.prototype,String.prototype,Number.prototype,Boolean.prototype].each(function(c){Object.extend(c,Test.BDDMethods)})};Test.context=function(d,e,c){Test.setupBDDExtensionMethods();var b={};var g={};for(specName in e){switch(specName){case"setup":case"teardown":b[specName]=e[specName];break;default:var f="test"+specName.gsub(/\s+/,"-").camelize();var a=e[specName].toString().split("\n").slice(1);if(/^\{/.test(a[0])){a=a.slice(1)}a.pop();a=a.map(function(h){return h.strip()});b[f]=a.join("\n");g[f]=specName}}new Test.Unit.Runner(b,{titles:g,testLog:c||"testlog",context:d})};